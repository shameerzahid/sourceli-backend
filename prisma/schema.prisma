generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  FARMER
  BUYER
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
  BLOCKED
  APPLIED
  PROBATIONARY  // For farmers who are approved but in probation period
}

enum BuyerType {
  RESTAURANT
  HOTEL
  CATERER
  INDIVIDUAL
}

enum OrderType {
  ONE_TIME
  STANDING
}

enum OrderStatus {
  PENDING
  APPROVED
  ALLOCATION
  DELIVERED
  FAILED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  DELIVERED
  FAILED
}

enum QualityResult {
  PASS
  PARTIAL
  FAIL
}

enum PaymentStatus {
  NOT_PAID
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  BANK_TRANSFER
  MOBILE_MONEY
  CASH
  OTHER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole
  status        UserStatus @default(PENDING)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  farmer        Farmer?
  buyer         Buyer?
  auditLogs     AuditLog[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
  @@index([role, status])
  @@map("users")
}

model Farmer {
  id                    String      @id @default(cuid())
  userId                String      @unique
  fullName              String      @map("full_name")
  farmName              String?     @map("farm_name")
  region                String
  town                  String
  weeklyCapacityMin     Int         @map("weekly_capacity_min")
  weeklyCapacityMax     Int         @map("weekly_capacity_max")
  produceCategory       String      @map("produce_category")
  feedingMethod         String      @map("feeding_method")
  verificationDate      DateTime?   @map("verification_date")
  verificationAdminId   String?     @map("verification_admin_id")
  
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  application           FarmerApplication?
  farmPhotos            FarmPhoto[]
  weeklyAvailability    WeeklyAvailability[]
  deliveryAssignments   DeliveryAssignment[]
  payments              Payment[]
  
  @@index([userId])
  @@index([region])
  @@index([produceCategory])
  @@map("farmers")
}

model Buyer {
  id                String      @id @default(cuid())
  userId            String      @unique
  fullName          String      @map("full_name")
  businessName      String?     @map("business_name")
  buyerType         BuyerType   @map("buyer_type")
  contactPerson     String      @map("contact_person")
  estimatedVolume   Int?        @map("estimated_volume")
  verificationDate  DateTime?   @map("verification_date")
  verificationAdminId String?   @map("verification_admin_id")
  
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  registration      BuyerRegistration?
  deliveryAddresses DeliveryAddress[]
  orders            Order[]
  
  @@index([userId])
  @@index([buyerType])
  @@map("buyers")
}

model DeliveryAddress {
  id          String   @id @default(cuid())
  buyerId     String   @map("buyer_id")
  address     String
  landmark    String?
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  
  buyer       Buyer    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  orders      Order[]
  assignments DeliveryAssignment[]
  
  @@index([buyerId])
  @@index([buyerId, isDefault])
  @@map("delivery_addresses")
}

model FarmerApplication {
  id              String      @id @default(cuid())
  farmerId        String      @unique @map("farmer_id")
  status          UserStatus  @default(APPLIED)
  termsAccepted   Boolean     @default(false) @map("terms_accepted")
  termsAcceptedAt DateTime?   @map("terms_accepted_at")
  submittedAt     DateTime    @default(now()) @map("submitted_at")
  reviewedAt      DateTime?   @map("reviewed_at")
  adminNotes      String?     @map("admin_notes")
  rejectionReason String?     @map("rejection_reason")
  
  farmer          Farmer      @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([submittedAt])
  @@map("farmer_applications")
}

model BuyerRegistration {
  id              String      @id @default(cuid())
  buyerId         String      @unique @map("buyer_id")
  status          UserStatus  @default(PENDING)
  submittedAt     DateTime    @default(now()) @map("submitted_at")
  reviewedAt      DateTime?   @map("reviewed_at")
  adminNotes      String?     @map("admin_notes")
  rejectionReason String?     @map("rejection_reason")
  
  buyer           Buyer       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([submittedAt])
  @@map("buyer_registrations")
}

model FarmPhoto {
  id            String   @id @default(cuid())
  farmerId      String   @map("farmer_id")
  filePath      String   @map("file_path")
  fileType      String   @map("file_type")
  uploadedAt    DateTime @default(now()) @map("uploaded_at")
  
  farmer        Farmer   @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  
  @@index([farmerId])
  @@map("farm_photos")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")
  actionType  String   @map("action_type")
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id")
  details     Json
  timestamp   DateTime @default(now())
  ipAddress   String?  @map("ip_address")
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([actionType])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

// Milestone 2 Models

model ProduceCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  unitType  String   @map("unit_type") // e.g., "kg", "units"
  createdAt DateTime @default(now()) @map("created_at")
  
  // Note: Orders and WeeklyAvailability reference productType as String (category name)
  // This allows flexibility and doesn't require foreign key constraints
  
  @@map("produce_categories")
}

model WeeklyAvailability {
  id               String    @id @default(cuid())
  farmerId         String    @map("farmer_id")
  weekStartDate    DateTime  @map("week_start_date")
  productType      String    @map("product_type")
  quantityAvailable Int      @map("quantity_available")
  avgWeight        Float?    @map("avg_weight")
  readyDate        DateTime  @map("ready_date")
  submittedAt      DateTime  @default(now()) @map("submitted_at")
  isLate           Boolean   @default(false) @map("is_late")
  
  farmer           Farmer    @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  
  @@unique([farmerId, weekStartDate, productType])
  @@index([farmerId])
  @@index([weekStartDate])
  @@index([productType])
  @@map("weekly_availability")
}

model Order {
  id                String      @id @default(cuid())
  buyerId           String      @map("buyer_id")
  productType       String      @map("product_type")
  quantity          Int
  orderType         OrderType   @map("order_type")
  deliveryDate      DateTime    @map("delivery_date")
  deliveryAddressId String      @map("delivery_address_id")
  status            OrderStatus @default(PENDING)
  notes             String?
  createdAt         DateTime    @default(now()) @map("created_at")
  approvedAt        DateTime?   @map("approved_at")
  approvedBy        String?     @map("approved_by")
  rejectionReason   String?     @map("rejection_reason")
  
  buyer             Buyer       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  deliveryAddress   DeliveryAddress @relation(fields: [deliveryAddressId], references: [id], onDelete: Restrict)
  assignments       DeliveryAssignment[]
  
  @@index([buyerId])
  @@index([status])
  @@index([deliveryDate])
  @@index([productType])
  @@map("orders")
}

model DeliveryAssignment {
  id                String           @id @default(cuid())
  orderId           String           @map("order_id")
  farmerId          String           @map("farmer_id")
  assignedQuantity  Int              @map("assigned_quantity")
  deliveryDate      DateTime         @map("delivery_date")
  deliveryAddressId String           @map("delivery_address_id")
  status            AssignmentStatus @default(PENDING)
  createdAt         DateTime         @default(now()) @map("created_at")
  
  // Delivery confirmation fields (US-ADMIN-008)
  quantityDelivered Int?             @map("quantity_delivered")
  qualityResult     QualityResult?    @map("quality_result")
  confirmationNotes String?           @map("confirmation_notes")
  confirmedBy       String?           @map("confirmed_by")
  confirmedAt       DateTime?         @map("confirmed_at")
  
  order             Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  farmer            Farmer           @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  deliveryAddress   DeliveryAddress  @relation(fields: [deliveryAddressId], references: [id], onDelete: Restrict)
  payments          Payment[]
  
  @@index([orderId])
  @@index([farmerId])
  @@index([deliveryDate])
  @@index([status])
  @@map("delivery_assignments")
}

model Payment {
  id                String        @id @default(cuid())
  farmerId          String        @map("farmer_id")
  deliveryAssignmentId String?     @map("delivery_assignment_id")
  amountOwed        Float         @map("amount_owed")
  amountPaid        Float         @default(0) @map("amount_paid")
  paymentStatus     PaymentStatus @default(NOT_PAID) @map("payment_status")
  paymentMethod     PaymentMethod? @map("payment_method")
  paymentDate       DateTime?     @map("payment_date")
  recordedBy        String        @map("recorded_by")
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  
  farmer            Farmer        @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  assignment        DeliveryAssignment? @relation(fields: [deliveryAssignmentId], references: [id], onDelete: SetNull)
  
  @@index([farmerId])
  @@index([paymentStatus])
  @@index([paymentDate])
  @@index([deliveryAssignmentId])
  @@map("payments")
}

